<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DiseÃ±ador de NeÃ³n</title>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300&family=Nunito:wght@300&family=Pacifico&family=Courgette&family=Yellowtail&family=Cookie&family=Kaushan+Script&family=Righteous&family=Orbitron:wght@400&family=Raleway:wght@300&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f2f0ec; --panel:#fff; --panel2:#f7f5f2;
  --border:#e4e0da; --border2:#ccc8c1;
  --accent:#d93b3e; --text:#1a1918; --muted:#8a8680;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;display:flex;flex-direction:column;}

header{height:52px;flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:0 24px;background:var(--panel);border-bottom:1px solid var(--border);}
.logo{font-size:.9rem;font-weight:800;letter-spacing:3px;text-transform:uppercase;}
.logo em{color:var(--accent);font-style:normal;}
.header-mid{font-size:.6rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--muted);}
.dots{display:flex;gap:5px;}
.dot{width:7px;height:7px;border-radius:50%;background:var(--border2);transition:.3s;}
.dot.on{background:var(--accent);transform:scale(1.2);}

.layout{flex:1;display:grid;grid-template-columns:305px 1fr;overflow:hidden;min-height:0;}

.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden;}
.sidebar::-webkit-scrollbar{width:3px;}
.sidebar::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

.block{padding:14px 16px;border-bottom:1px solid var(--border);}
.bhead{display:flex;align-items:center;gap:7px;margin-bottom:10px;}
.num{width:18px;height:18px;border-radius:50%;background:var(--accent);color:#fff;font-size:.55rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.blabel{font-size:.58rem;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);}

textarea{width:100%;background:var(--panel2);border:1.5px solid var(--border);border-radius:7px;color:var(--text);font-size:.9rem;padding:9px 11px;resize:none;height:72px;font-family:inherit;outline:none;transition:border-color .18s;line-height:1.5;}
textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(217,59,62,.09);}
.char-row{display:flex;justify-content:space-between;margin-top:5px;font-size:.58rem;color:var(--muted);}

.font-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.fbtn{background:var(--panel2);border:1.5px solid var(--border);border-radius:7px;height:42px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.92rem;color:var(--text);transition:all .15s;overflow:hidden;padding:0 5px;}
.fbtn:hover{border-color:var(--accent);background:rgba(217,59,62,.04);}
.fbtn.on{border-color:var(--accent);background:rgba(217,59,62,.09);color:var(--accent);}

.color-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:7px;}
.cswatch{aspect-ratio:1;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all .15s;box-shadow:0 1px 4px rgba(0,0,0,.14);}
.cswatch:hover{transform:scale(1.14);}
.cswatch.on{border-color:#111;transform:scale(1.12);box-shadow:0 0 0 3px rgba(0,0,0,.11);}
.clabel{font-size:.62rem;color:var(--muted);text-align:center;margin-top:6px;}

.wall-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;}
.wbtn{aspect-ratio:.75;border-radius:7px;cursor:pointer;border:2.5px solid transparent;overflow:hidden;position:relative;background-size:cover;background-position:center top;transition:all .18s;}
.wbtn:hover{transform:scale(1.04);box-shadow:0 4px 14px rgba(0,0,0,.25);}
.wbtn.on{border-color:var(--accent);box-shadow:0 0 0 3px rgba(217,59,62,.22);}
.wbtn span{position:absolute;bottom:0;left:0;right:0;padding:3px 4px 4px;background:linear-gradient(transparent,rgba(0,0,0,.7));font-size:.48rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;color:rgba(255,255,255,.95);text-align:center;}

.mount-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.mbtn{background:var(--panel2);border:1.5px solid var(--border);border-radius:7px;padding:9px 6px;cursor:pointer;text-align:center;font-size:.62rem;font-weight:600;color:var(--muted);font-family:inherit;line-height:1.4;transition:all .15s;}
.mbtn:hover{border-color:var(--accent);color:var(--text);}
.mbtn.on{border-color:var(--accent);color:var(--accent);background:rgba(217,59,62,.07);}
.mico{font-size:1.15rem;display:block;margin-bottom:2px;}

.extras{display:flex;flex-direction:column;gap:10px;}
.trow{display:flex;justify-content:space-between;align-items:center;}
.tname{font-size:.75rem;font-weight:600;color:var(--text);}
.tdesc{font-size:.6rem;color:var(--muted);margin-top:1px;}
.toggle{position:relative;width:38px;height:21px;cursor:pointer;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.tslider{position:absolute;inset:0;background:var(--border2);border-radius:21px;transition:.25s;}
.tslider::before{content:'';position:absolute;left:3px;top:3px;width:15px;height:15px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.2);transition:.25s;}
.toggle input:checked+.tslider{background:var(--accent);}
.toggle input:checked+.tslider::before{transform:translateX(17px);}

.preview-col{display:flex;flex-direction:column;overflow:hidden;min-height:0;}
.preview-bar{height:44px;flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:0 18px;background:var(--panel);border-bottom:1px solid var(--border);gap:8px;}
.bar-label{font-size:.58rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.bar-actions{display:flex;gap:6px;}
.ibtn{background:var(--panel2);border:1.5px solid var(--border);border-radius:6px;padding:5px 11px;font-size:.65rem;font-weight:600;font-family:inherit;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s;}
.ibtn:hover{border-color:var(--accent);color:var(--accent);}

.preview-canvas{flex:1;min-height:0;position:relative;overflow:hidden;background-size:cover;background-position:center;cursor:default;}
.canvas-overlay{position:absolute;inset:0;background:rgba(0,0,0,.38);pointer-events:none;z-index:1;transition:background .3s;}

/* Perspective container â€” wraps signWrapper for 3D transforms */
#perspectiveWrap{
  position:absolute;
  inset:0;
  perspective:900px;
  perspective-origin:50% 50%;
  pointer-events:none;
  z-index:10;
}
#signWrapper{
  position:absolute;
  z-index:10;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  transform-origin:center center;
  transform-style:preserve-3d;
  cursor:grab;user-select:none;touch-action:none;
  overflow:visible;
  width:max-content;
  pointer-events:auto;
}
#signWrapper:active{cursor:grabbing;}

#mountPlate{position:absolute;pointer-events:none;opacity:0;}
#mountHook{position:absolute;left:50%;transform:translateX(-50%);pointer-events:none;display:none;z-index:-1;}
#mountBase{position:absolute;left:50%;bottom:-30px;transform:translateX(-50%);pointer-events:none;display:none;z-index:-1;}
#mountScrews{position:absolute;inset:-6px -8px;pointer-events:none;display:none;}
.screw{position:absolute;width:9px;height:9px;border-radius:50%;background:#aaa;border:2px solid #777;box-shadow:inset 0 1px 2px rgba(255,255,255,.5),0 1px 3px rgba(0,0,0,.4);}
.screw::after{content:'';position:absolute;inset:1px;background:linear-gradient(135deg,#999 40%,#666);border-radius:50%;}

#acrylicCanvas{
  position:absolute;
  z-index:1;
  pointer-events:none;
  opacity:0;
  transition:opacity .3s;
  filter:drop-shadow(0 0 12px rgba(255,255,255,.25));
}

/* neonText: display inline-block + nowrap â†’ el ancho lo dicta el texto,
   nunca el contenedor padre. El wrapper escala todo uniformemente. */
#neonText{
  display:inline-block;
  text-align:center;
  line-height:1.2;
  white-space:pre;
  padding:16px 28px;
  pointer-events:auto;
  position:relative;
  z-index:2;
  transition:color .2s,text-shadow .2s;
  paint-order:stroke fill;
}

#resizeHandle{position:absolute;bottom:-8px;right:-8px;width:22px;height:22px;background:rgba(20,20,30,.85);border-radius:50%;cursor:se-resize;border:2px solid rgba(255,255,255,.55);box-shadow:0 2px 8px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:20;transition:background .15s,transform .15s;}
#resizeHandle:hover{background:rgba(217,59,62,.9);border-color:#fff;transform:scale(1.15);}
#resizeHandle svg{width:10px;height:10px;}

#sizeHint{
  position:absolute;
  bottom:-34px;
  right:-8px;
  background:rgba(0,0,0,.78);
  color:#fff;
  font-size:.55rem;
  font-weight:700;
  letter-spacing:.4px;
  padding:3px 8px 3px 7px;
  border-radius:5px;
  white-space:nowrap;
  pointer-events:none;
  opacity:0;
  transition:opacity .35s;
  transform-origin:top right;
}
/* Flecha apuntando arriba-derecha hacia el resizeHandle */
#sizeHint::before{
  content:'';
  position:absolute;
  bottom:100%;
  right:10px;
  border:5px solid transparent;
  border-bottom-color:rgba(0,0,0,.78);
}

.dim-badge{position:absolute;bottom:12px;right:14px;z-index:3;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.14);border-radius:5px;padding:4px 10px;font-size:.63rem;font-weight:600;color:rgba(255,255,255,.65);backdrop-filter:blur(5px);letter-spacing:.3px;}
.scroll-hint{position:absolute;bottom:12px;left:14px;z-index:3;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.1);border-radius:5px;padding:4px 9px;font-size:.58rem;color:rgba(255,255,255,.5);backdrop-filter:blur(4px);pointer-events:none;}

@keyframes flicker{0%,93%,100%{opacity:1;}94%{opacity:.7;}95%{opacity:1;}97%{opacity:.42;}98%{opacity:1;}}
.flicker{animation:flicker 5s infinite;}
.dimmed{opacity:.55;}

#rainCanvas{position:absolute;inset:0;pointer-events:none;z-index:5;display:none;}

/* â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â• */
@media (max-width:768px){
  html,body{overflow:hidden;height:100%;}
  header{padding:0 14px;height:46px;}
  .logo{font-size:.75rem;letter-spacing:2px;}
  .header-mid{display:none;}
  .layout{grid-template-columns:1fr;grid-template-rows:1fr auto;overflow:hidden;}
  .preview-col{grid-row:1;min-height:0;position:relative;}
  .preview-bar{height:38px;padding:0 10px;}
  .bar-label{display:none;}
  .ibtn{padding:4px 8px;font-size:.6rem;}
  .ibtn .btn-text{display:none;}
  .sidebar{grid-row:2;border-right:none;border-top:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;height:var(--sheet-h,52px);transition:height .35s cubic-bezier(.4,0,.2,1);position:relative;background:var(--panel);z-index:50;}
  .sheet-handle{display:flex;flex-direction:column;align-items:center;padding:8px 0 4px;cursor:pointer;flex-shrink:0;gap:2px;}
  .sheet-pill{width:36px;height:4px;border-radius:2px;background:var(--border2);}
  .sheet-tabs{display:flex;gap:0;width:100%;overflow-x:auto;overflow-y:hidden;scrollbar-width:none;border-bottom:1px solid var(--border);flex-shrink:0;}
  .sheet-tabs::-webkit-scrollbar{display:none;}
  .stab{flex-shrink:0;padding:5px 12px;font-size:.55rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap;background:none;border-top:none;border-left:none;border-right:none;font-family:inherit;}
  .stab.on{color:var(--accent);border-bottom-color:var(--accent);}
  .sheet-content{flex:1;overflow-y:auto;overflow-x:hidden;}
  .block{display:none;}
  .block.active{display:block;}
  .font-grid{grid-template-columns:repeat(3,1fr);}
  .wall-grid{grid-template-columns:repeat(4,1fr);}
  .color-grid{grid-template-columns:repeat(6,1fr);}
  #resizeHandle{width:28px;height:28px;bottom:-10px;right:-10px;}
  #sizeHint{font-size:.52rem;}
}
@media (max-width:380px){
  .font-grid{grid-template-columns:1fr 1fr;}
  .wall-grid{grid-template-columns:repeat(3,1fr);}
}

/* â•â•â• CHAR EDIT â•â•â• */
.nchar{
  display:inline;
  cursor:pointer;
  position:relative;
  transition:text-shadow .15s;
}
.nchar.selected{
  outline:2px solid rgba(255,255,255,.5);
  outline-offset:3px;
  border-radius:3px;
}
.nchar-nl{ display:block; height:0; }

#charMenu{
  position:absolute;
  z-index:100;
  background:rgba(12,13,18,.95);
  border:1px solid rgba(255,255,255,.12);
  border-radius:10px;
  padding:8px 10px;
  box-shadow:0 8px 28px rgba(0,0,0,.75);
  backdrop-filter:blur(14px);
  pointer-events:auto;
  display:none;
  white-space:nowrap;
}
#charMenu.visible{ display:flex; align-items:center; gap:8px; }
#charMenu::after{
  content:'';
  position:absolute;
  top:100%; left:50%;
  transform:translateX(-50%);
  border:6px solid transparent;
  border-top-color:rgba(12,13,18,.95);
}

/* Carrusel de fuentes */
.cmenu-carousel{
  display:flex;
  align-items:center;
  gap:4px;
}
.cmenu-arr{
  background:none;
  border:none;
  color:rgba(255,255,255,.5);
  font-size:1rem;
  cursor:pointer;
  padding:0 2px;
  line-height:1;
  transition:color .12s;
  flex-shrink:0;
}
.cmenu-arr:hover{ color:#fff; }
.cmenu-font-name{
  font-size:.82rem;
  color:#fff;
  min-width:80px;
  text-align:center;
  padding:4px 8px;
  background:rgba(255,255,255,.08);
  border-radius:6px;
  border:1px solid rgba(255,255,255,.12);
  cursor:default;
}

/* Separador */
.cmenu-sep{
  width:1px;
  height:24px;
  background:rgba(255,255,255,.12);
  flex-shrink:0;
}

/* Swatch de color activo + submenu */
.cmenu-color-wrap{
  position:relative;
}
.cmenu-color-btn{
  width:22px; height:22px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.5);
  cursor:pointer;
  transition:transform .12s;
  flex-shrink:0;
  display:block;
}
.cmenu-color-btn:hover{ transform:scale(1.15); }
.cmenu-color-sub{
  position:absolute;
  bottom:calc(100% + 10px);
  left:50%;
  transform:translateX(-50%);
  background:rgba(12,13,18,.97);
  border:1px solid rgba(255,255,255,.12);
  border-radius:10px;
  padding:8px;
  display:none;
  flex-wrap:wrap;
  gap:6px;
  width:154px;
  box-shadow:0 6px 24px rgba(0,0,0,.8);
}
.cmenu-color-sub.open{ display:flex; }
.cmenu-color-sub::after{
  content:'';
  position:absolute;
  top:100%; left:50%;
  transform:translateX(-50%);
  border:6px solid transparent;
  border-top-color:rgba(12,13,18,.97);
}
.cmenu-csw{
  width:20px; height:20px;
  border-radius:50%;
  cursor:pointer;
  border:2px solid transparent;
  transition:all .12s;
  flex-shrink:0;
}
.cmenu-csw:hover{ transform:scale(1.18); }
.cmenu-csw.on{ border-color:#fff; transform:scale(1.1); }

/* Reset */
.cmenu-reset{
  background:none;
  border:none;
  color:rgba(255,255,255,.35);
  font-size:.85rem;
  cursor:pointer;
  padding:0 2px;
  transition:color .12s;
  line-height:1;
  flex-shrink:0;
}
.cmenu-reset:hover{ color:rgba(255,100,100,.8); }

/* â•â•â• ROTATE HANDLE â•â•â• */
#rotateHandle{
  position:absolute;
  top:-38px;
  left:50%;
  transform:translateX(-50%);
  width:24px; height:24px;
  background:rgba(20,20,30,.85);
  border:2px solid rgba(255,255,255,.55);
  border-radius:50%;
  cursor:grab;
  z-index:20;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 2px 8px rgba(0,0,0,.5);
  transition:background .15s, transform .15s;
  pointer-events:auto;
}
#rotateHandle:hover{
  background:rgba(217,59,62,.9);
  border-color:#fff;
  transform:translateX(-50%) scale(1.15);
}
#rotateHandle.active{
  cursor:grabbing;
  background:rgba(217,59,62,.9);
}
/* LÃ­nea conectora del handle al wrapper */
#rotateHandle::after{
  content:'';
  position:absolute;
  top:100%; left:50%;
  transform:translateX(-50%);
  width:1px; height:10px;
  background:rgba(255,255,255,.3);
}
#rotateHandle svg{ width:12px; height:12px; pointer-events:none; }

/* Badge de Ã¡ngulo */
#angleBadge{
  position:absolute;
  top:-68px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.75);
  color:#fff;
  font-size:.55rem;
  font-weight:700;
  letter-spacing:.5px;
  padding:3px 7px;
  border-radius:4px;
  white-space:nowrap;
  pointer-events:none;
  opacity:0;
  transition:opacity .15s;
}
#angleBadge.visible{ opacity:1; }

/* â•â•â• TILT HANDLES (3D) â•â•â• */
.tiltHandle{
  position:absolute;
  top:50%;
  width:20px; height:20px;
  transform:translateY(-50%);
  background:rgba(20,20,30,.85);
  border:2px solid rgba(255,255,255,.45);
  border-radius:50%;
  cursor:ns-resize;
  z-index:20;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 2px 8px rgba(0,0,0,.5);
  transition:background .15s;
  pointer-events:auto;
}
.tiltHandle:hover{ background:rgba(217,59,62,.9); border-color:#fff; }
.tiltHandle.active{ background:rgba(217,59,62,.9); cursor:grabbing; }
.tiltHandle svg{ width:10px; height:10px; pointer-events:none; }
#tiltHandleY{ right:-30px; cursor:ew-resize; }  /* eje Y â€” lado derecho, drag horizontal */

/* Badge compartido para tilt */
#tiltBadge{
  position:absolute;
  top:-68px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.75);
  color:#fff;
  font-size:.55rem;
  font-weight:700;
  letter-spacing:.4px;
  padding:3px 7px;
  border-radius:4px;
  white-space:nowrap;
  pointer-events:none;
  opacity:0;
  transition:opacity .15s;
}
#tiltBadge.visible{ opacity:1; }

body.preview-mode header,
body.preview-mode .sidebar,
body.preview-mode .preview-bar {
  display: none !important;
}

body.preview-mode .sidebar {
  visibility: hidden;
  pointer-events: none;
}

body.preview-mode .preview-col {
  position: fixed;
  inset: 0;
  z-index: 999;
  background: #000;
  padding: 0 !important;
  margin: 0 !important;
}

body.preview-mode .preview-canvas {
  width: 100% !important;
  height: 100% !important;
  aspect-ratio: auto !important;
  max-width: none !important;
  max-height: none !important;
}
</style>
</head>
<body>

<header>
  <div class="logo">ILUMIA<em>MX</em></div>
  <div class="header-mid">DiseÃ±ador de Letreros</div>
  <div class="dots">
    <div class="dot on" id="d1"></div><div class="dot" id="d2"></div>
    <div class="dot" id="d3"></div><div class="dot" id="d4"></div>
    <div class="dot" id="d5"></div><div class="dot" id="d6"></div>
  </div>
</header>

<div class="layout">
<aside class="sidebar" id="sidebar">
  <div class="sheet-handle" id="sheetHandle" style="display:none"><div class="sheet-pill"></div></div>
  <div class="sheet-tabs" id="sheetTabs" style="display:none"></div>
  <div class="sheet-content" id="sheetContent">

  <div class="block" data-tab="Texto" data-idx="0">
    <div class="bhead"><span class="num">1</span><span class="blabel">Tu Texto</span></div>
    <textarea id="textInput" placeholder="Escribe tu texto aquÃ­&#10;(Enter = nueva lÃ­nea)">Hello World</textarea>
    <div class="char-row"><span id="charCount">11 caracteres</span><span>MÃ¡x. 60</span></div>
  </div>

  <div class="block" data-tab="Fuente" data-idx="1">
    <div class="bhead"><span class="num">2</span><span class="blabel">TipografÃ­a</span></div>
    <div class="font-grid" id="fontGrid">
      <div class="fbtn on"  data-font="Pacifico"       style="font-family:'Pacifico'">Pacifico</div>
      <div class="fbtn"     data-font="Courgette"      style="font-family:'Courgette'">Courgette</div>
      <div class="fbtn"     data-font="Yellowtail"     style="font-family:'Yellowtail'">Yellowtail</div>
      <div class="fbtn"     data-font="Cookie"         style="font-family:'Cookie';font-size:1.1rem">Cookie</div>
      <div class="fbtn"     data-font="Kaushan Script" style="font-family:'Kaushan Script'">Kaushan</div>
      <div class="fbtn"     data-font="Comfortaa"      style="font-family:'Comfortaa';font-weight:300">Comfortaa</div>
      <div class="fbtn"     data-font="Nunito"         style="font-family:'Nunito';font-weight:300">Nunito</div>
      <div class="fbtn"     data-font="Raleway"        style="font-family:'Raleway';font-weight:300;letter-spacing:2px;font-size:.8rem">Raleway</div>
      <div class="fbtn"     data-font="Righteous"      style="font-family:'Righteous'">Righteous</div>
      <div class="fbtn"     data-font="Orbitron"       style="font-family:'Orbitron';font-size:.68rem">Orbitron</div>
    </div>
  </div>

  <div class="block" data-tab="Color" data-idx="2">
    <div class="bhead"><span class="num">3</span><span class="blabel">Color del NeÃ³n</span></div>
    <div class="color-grid" id="colorGrid">
      <div class="cswatch on" style="background:#b3f0ff" data-c="#b3f0ff" data-n="Azul Hielo"></div>
      <div class="cswatch"    style="background:#ff2222" data-c="#ff2222" data-n="Roja"></div>
      <div class="cswatch"    style="background:#ffb300" data-c="#ffb300" data-n="Amber"></div>
      <div class="cswatch"    style="background:#e8ff00" data-c="#e8ff00" data-n="Amarillo LimÃ³n"></div>
      <div class="cswatch"    style="background:#bf00ff" data-c="#bf00ff" data-n="Morado"></div>
      <div class="cswatch"    style="background:#00ff88" data-c="#00ff88" data-n="Verde"></div>
      <div class="cswatch"    style="background:#39ff14" data-c="#39ff14" data-n="Verde Mars"></div>
      <div class="cswatch"    style="background:#3b82f6" data-c="#3b82f6" data-n="Azul"></div>
      <div class="cswatch"    style="background:#ff3cac" data-c="#ff3cac" data-n="Rosa"></div>
      <div class="cswatch"    style="background:#ffd700" data-c="#ffd700" data-n="Amarillo Dorado"></div>
      <div class="cswatch"    style="background:#ff8800" data-c="#ff8800" data-n="Naranja"></div>
      <div class="cswatch"    style="background:#e8f4ff" data-c="#e8f4ff" data-n="Blanca FrÃ­a"></div>
    </div>
    <div class="clabel" id="colorLabel">Azul Hielo</div>
  </div>

  <div class="block" data-tab="Pared" data-idx="3">
    <div class="bhead"><span class="num">4</span><span class="blabel">Pared / Ambiente</span></div>
    <div class="wall-grid" id="wallGrid">
      <div class="wbtn on" style="background-image:url('https://images.unsplash.com/photo-1770816306935-d0a08e93d823?w=400&q=80&fit=crop')" data-url="https://images.unsplash.com/photo-1770816306935-d0a08e93d823?w=1400&q=85" data-ov=".25"><span>Local 1</span></div>
      <div class="wbtn" style="background-image:url('https://plus.unsplash.com/premium_photo-1728155006673-887f27d7694f?w=400&q=80&fit=crop')" data-url="https://plus.unsplash.com/premium_photo-1728155006673-887f27d7694f?w=1400&q=85" data-ov=".30"><span>Local 2</span></div>
      <div class="wbtn" style="background-image:url('https://images.unsplash.com/photo-1769501203673-159257ecb72d?w=400&q=80&fit=crop')" data-url="https://images.unsplash.com/photo-1769501203673-159257ecb72d?w=1400&q=85" data-ov=".28"><span>Local 3</span></div>
      <div class="wbtn" style="background-image:url('https://images.unsplash.com/photo-1770646403987-64cf5c08c870?w=400&q=80&fit=crop')" data-url="https://images.unsplash.com/photo-1770646403987-64cf5c08c870?w=1400&q=85" data-ov=".32"><span>Local 4</span></div>
      <div class="wbtn" style="background-image:url('https://images.unsplash.com/photo-1770319675686-ae3b11647bcd?w=400&q=80&fit=crop')" data-url="https://images.unsplash.com/photo-1770319675686-ae3b11647bcd?w=1400&q=85" data-ov=".28"><span>Local 5</span></div>
      <div class="wbtn" style="background-image:url('https://plus.unsplash.com/premium_photo-1683121299733-06eed1e7df79?w=400&q=80&fit=crop')" data-url="https://plus.unsplash.com/premium_photo-1683121299733-06eed1e7df79?w=1400&q=85" data-ov=".35"><span>Local 6</span></div>
      <div class="wbtn" style="background-image:url('https://images.unsplash.com/photo-1526887593587-a307ea5d46b4?w=400&q=80&fit=crop')" data-url="https://images.unsplash.com/photo-1526887593587-a307ea5d46b4?w=1400&q=85" data-ov=".30"><span>Local 7</span></div>
      <div class="wbtn" style="background-image:url('https://images.unsplash.com/photo-1566073771259-6a8506099945?w=400&q=80&fit=crop')" data-url="https://images.unsplash.com/photo-1566073771259-6a8506099945?w=1400&q=85" data-ov=".28"><span>Hotel Lobby</span></div>
    </div>
  </div>

  <div class="block" data-tab="Montaje" data-idx="4">
    <div class="bhead"><span class="num">5</span><span class="blabel">Tipo de Montaje</span></div>
    <div class="mount-grid" id="mountGrid">
      <button class="mbtn on" data-m="libre"><span class="mico">âœ¨</span>Sin sujeciÃ³n<br><small style="font-size:.55rem;opacity:.7">SÃ³lo el letrero</small></button>
      <button class="mbtn" data-m="colgar"><span class="mico">ğŸª</span>Para colgar<br><small style="font-size:.55rem;opacity:.7">Cable colgante</small></button>
      <button class="mbtn" data-m="acrilico-cuadrado"><span class="mico">â¬œ</span>AcrÃ­lico Cuadrado<br><small style="font-size:.55rem;opacity:.7">Placa rectangular</small></button>
      <button class="mbtn" data-m="acrilico-redondo"><span class="mico">â­•</span>AcrÃ­lico Redondo<br><small style="font-size:.55rem;opacity:.7">Placa circular</small></button>
    </div>
  </div>

  <div class="block" data-tab="Extras" data-idx="5">
    <div class="bhead"><span class="num">6</span><span class="blabel">Opciones Adicionales</span></div>
    <div class="extras">
      <div class="trow">
        <div><div class="tname">Backing AcrÃ­lico</div><div class="tdesc">Placa recortada en la forma exacta del texto</div></div>
        <label class="toggle"><input type="checkbox" id="tBacking"><span class="tslider"></span></label>
      </div>
      <div class="trow">
        <div><div class="tname">RGB Multicolor</div><div class="tdesc">Ciclo de colores animado</div></div>
        <label class="toggle"><input type="checkbox" id="tRgb"><span class="tslider"></span></label>
      </div>
      <div class="trow">
        <div><div class="tname">Efecto Parpadeo</div><div class="tdesc">AnimaciÃ³n vintage de neÃ³n clÃ¡sico</div></div>
        <label class="toggle"><input type="checkbox" id="tFlicker"><span class="tslider"></span></label>
      </div>
      <div class="trow">
        <div><div class="tname">Control de Brillo</div><div class="tdesc">Simula intensidad baja â€” dimmer fÃ­sico incluido</div></div>
        <label class="toggle"><input type="checkbox" id="tDimmer"><span class="tslider"></span></label>
      </div>

      <div class="trow" style="padding-top:10px;border-top:1px solid var(--border);margin-top:2px;">
        <div><div class="tname" style="font-size:.85rem;">ğŸ’¡ NeÃ³n Encendido</div><div class="tdesc">Apaga para ver el letrero sin luz</div></div>
        <label class="toggle"><input type="checkbox" id="tPower" checked><span class="tslider"></span></label>
      </div>
    </div>
  </div>
  </div>
</aside>

<div class="preview-col">
  <div class="preview-bar">
    <div class="bar-label">Vista previa Â· Arrastra y redimensiona el letrero</div>
    <div class="bar-actions">
      <button class="ibtn" onclick="resetPosition()">âŠ™ <span class="btn-text">Centrar</span></button>
      <button class="ibtn" id="btnPreview">ğŸ‘ <span class="btn-text">Preview</span></button>
    </div>
  </div>
  <div class="preview-canvas" id="previewCanvas"
    style="background-image:url('https://images.unsplash.com/photo-1770816306935-d0a08e93d823?w=1400&q=85')">
    <div class="canvas-overlay" id="canvasOverlay"></div>
    <canvas id="rainCanvas"></canvas>
    <div id="perspectiveWrap">
    <div id="signWrapper">
      <div id="angleBadge">0Â°</div>
      <div id="rotateHandle">
        <svg viewBox="0 0 14 14" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round">
          <path d="M2.5 7 A4.5 4.5 0 1 1 7 11.5"/>
          <polyline points="2.5,4.5 2.5,7 5,7"/>
        </svg>
      </div>
      <div id="sizeHint">esquina para redimensionar â†—</div>
      <div id="tiltBadge">0Â°</div>
      <div class="tiltHandle" id="tiltHandleY" title="Inclinar â€” arrastra â†”">
        <svg viewBox="0 0 10 10" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round">
          <line x1="1" y1="5" x2="9" y2="5"/>
          <polyline points="3,2 1,5 3,8"/>
          <polyline points="7,2 9,5 7,8"/>
        </svg>
      </div>
      <div id="mountPlate"></div>
      <div id="mountHook"></div>
      <div id="mountBase"></div>
      <div id="mountScrews"></div>
      <canvas id="acrylicCanvas"></canvas>
      <div id="neonText" style="font-family:'Pacifico'">Hello World</div>
      <div id="charMenu">
  <!-- Carrusel fuente -->
  <div class="cmenu-carousel">
    <button class="cmenu-arr" id="cmenuPrev">â€¹</button>
    <div class="cmenu-font-name" id="cmenuFontName">Pacifico</div>
    <button class="cmenu-arr" id="cmenuNext">â€º</button>
  </div>
  <div class="cmenu-sep"></div>
  <!-- Color -->
  <div class="cmenu-color-wrap">
    <div class="cmenu-color-btn" id="cmenuColorBtn"></div>
    <div class="cmenu-color-sub" id="cmenuColorSub"></div>
  </div>
  <div class="cmenu-sep"></div>
  <!-- Reset -->
  <button class="cmenu-reset" id="cmenuReset" title="Restablecer">â†º</button>
</div>
<div id="resizeHandle">
        <svg viewBox="0 0 10 10"><line x1="2" y1="8" x2="8" y2="2" stroke="white" stroke-width="1.5" stroke-linecap="round"/><line x1="5" y1="8" x2="8" y2="5" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>
      </div>
    </div>
    </div><!-- /perspectiveWrap -->
    <div class="dim-badge" id="dimBadge">~ 60 Ã— 20 cm</div>
    <div class="scroll-hint" id="scrollHint">ğŸ–± Rueda del ratÃ³n = redimensionar</div>
  </div>
</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  text:'Hello World', font:'Pacifico', color:'#b3f0ff',
  scale:1, posX:0, posY:0, rotation:0, tiltY:0, bgX:50, bgY:50,
  mount:'libre',
  backing:false, rgb:false, flicker:false, dimmer:false, power:true,
  charOverrides:{},  // idx â†’ {font, color}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM REFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const neonEl        = document.getElementById('neonText');
const signWrapper   = document.getElementById('signWrapper');
const previewCanvas = document.getElementById('previewCanvas');
const overlay       = document.getElementById('canvasOverlay');
const mountPlate    = document.getElementById('mountPlate');
const mountHook     = document.getElementById('mountHook');
const mountBase     = document.getElementById('mountBase');
const mountScrews   = document.getElementById('mountScrews');
const rainCvs       = document.getElementById('rainCanvas');
const rainCtx       = rainCvs.getContext('2d');
const acrylicCvs    = document.getElementById('acrylicCanvas');
const acrylicCtx    = acrylicCvs.getContext('2d');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FONT-SIZE DINÃMICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcBaseFontSize() {
  const cw = previewCanvas.offsetWidth  || 800;
  const ch = previewCanvas.offsetHeight || 400;

  const lines  = (S.text || 'A').split('\n');
  const maxLen = Math.max(...lines.map(l => l.length), 1);

  const fsFromW = (cw * 0.78) / (maxLen * 0.58);
  const fsFromH = (ch * 0.65) / (lines.length * 1.2);

  const fsCeil = cw < 600 ? 48 : 72;

  return Math.max(14, Math.min(fsCeil, fsFromW, fsFromH));
}

let currentFS = 72;

function recalcFontSize(){
  currentFS = calcBaseFontSize();
  renderNeon();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RGB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RGB_COLORS = ['#ff3cac','#00f5ff','#00ff88','#ffee00','#ff8800','#bf00ff','#3b82f6'];
let rgbInt = null, ri = 0, currentRGBColor = RGB_COLORS[0];

function startRGB(){
  rgbInt = setInterval(()=>{
    currentRGBColor = RGB_COLORS[ri++ % RGB_COLORS.length];
    neonEl.style.color = currentRGBColor;
    neonEl.style.textShadow = tubeShadow(currentRGBColor);
    neonEl.style.webkitTextStroke = tubeStroke(currentRGBColor);
    if(S.backing) drawAcrylic();
  }, 700);
}
function stopRGB(){ clearInterval(rgbInt); currentRGBColor = RGB_COLORS[0]; renderNeon(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACRYLIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let acrylicRaf = null;

function drawAcrylic(){
  if(!S.backing){ acrylicCvs.style.opacity='0'; return; }
  cancelAnimationFrame(acrylicRaf);
  acrylicRaf = requestAnimationFrame(()=> requestAnimationFrame(()=> _renderAcrylic()));
}

function _renderAcrylic(){
  const PAD = 44;
  const nW = neonEl.offsetWidth;
  const nH = neonEl.offsetHeight;
  const nL = neonEl.offsetLeft;
  const nT = neonEl.offsetTop;
  const cvW = nW + PAD * 2;
  const cvH = nH + PAD * 2;

  acrylicCvs.width          = cvW;
  acrylicCvs.height         = cvH;
  acrylicCvs.style.width    = cvW + 'px';
  acrylicCvs.style.height   = cvH + 'px';
  acrylicCvs.style.left     = (nL - PAD) + 'px';
  acrylicCvs.style.top      = (nT - PAD) + 'px';
  acrylicCvs.style.position = 'absolute';

  const lines   = (S.text || ' ').split('\n');
  const fs      = currentFS;
  const lh      = fs * 1.2;

  const off = new OffscreenCanvas(cvW, cvH);
  const ox  = off.getContext('2d');
  ox.font         = `${fs}px '${S.font}', cursive`;
  ox.textAlign    = 'center';
  ox.textBaseline = 'alphabetic';
  ox.fillStyle    = '#fff';

  const met         = ox.measureText('Mg');
  const ascent      = met.fontBoundingBoxAscent  || fs * 0.78;
  const descent     = met.fontBoundingBoxDescent || fs * 0.22;
  const halfLeading = (lh - (ascent + descent)) / 2;

  const firstBaseline = PAD + 16 + halfLeading + ascent;

  lines.forEach((ln, i) => ox.fillText(ln || ' ', cvW / 2, firstBaseline + i * lh));

  function threshold(src, blurR, thr){
    const s = new OffscreenCanvas(cvW, cvH);
    const c = s.getContext('2d');
    c.filter = `blur(${blurR}px)`; c.drawImage(src, 0, 0); c.filter = 'none';
    const id = c.getImageData(0, 0, cvW, cvH), d = id.data;
    for(let i = 3; i < d.length; i += 4) d[i] = d[i] > thr ? 255 : 0;
    c.putImageData(id, 0, 0);
    return s;
  }

  const silOuter = threshold(off,      16,  15);
  const silInner = threshold(silOuter,  3, 180);

  const ring = new OffscreenCanvas(cvW, cvH);
  const rc   = ring.getContext('2d');
  const grad = rc.createLinearGradient(0, 0, cvW * 0.7, cvH);
  grad.addColorStop(0,   'rgba(220,230,245,0.22)');
  grad.addColorStop(0.5, 'rgba(180,195,220,0.15)');
  grad.addColorStop(1,   'rgba(200,215,235,0.20)');
  rc.fillStyle = grad;
  rc.fillRect(0, 0, cvW, cvH);
  rc.globalCompositeOperation = 'destination-in';
  rc.drawImage(silOuter, 0, 0);

  const rim = new OffscreenCanvas(cvW, cvH);
  const rm  = rim.getContext('2d');
  rm.fillStyle = 'rgba(255,255,255,0.28)';
  rm.fillRect(0, 0, cvW, cvH);
  rm.globalCompositeOperation = 'destination-in';
  rm.drawImage(silOuter, 0, 0);
  rm.globalCompositeOperation = 'destination-out';
  rm.drawImage(silInner, 0, 0);

  acrylicCtx.clearRect(0, 0, cvW, cvH);
  acrylicCtx.drawImage(ring, 0, 0);
  acrylicCtx.drawImage(rim,  0, 0);
  acrylicCvs.style.filter  = 'drop-shadow(0 4px 20px rgba(0,0,0,0.5))';
  acrylicCvs.style.opacity = '1';
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEON TUBE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hexToRgb(hex){
  const r=parseInt(hex.slice(1,3),16);
  const g=parseInt(hex.slice(3,5),16);
  const b=parseInt(hex.slice(5,7),16);
  return {r,g,b};
}
function darken(hex, factor){
  const {r,g,b}=hexToRgb(hex);
  return `rgb(${Math.round(r*factor)},${Math.round(g*factor)},${Math.round(b*factor)})`;
}
function rgba(hex, a){
  const {r,g,b}=hexToRgb(hex);
  return `rgba(${r},${g},${b},${a})`;
}

function tubeShadow(c){
  const d1 = darken(c, 0.75);
  const d2 = darken(c, 0.55);
  const d3 = darken(c, 0.38);
  const d4 = darken(c, 0.22);
  return [
    `1px 1px 0 ${d1}`,
    `2px 2px 0 ${d2}`,
    `3px 3px 0 ${d3}`,
    `4px 4px 0 ${d4}`,
    `5px 5px 0 rgba(255,255,255,0.85)`,
    `6px 6px 1px rgba(0,0,0,0.3)`,
    `0 0 3px ${c}`,
    `0 0 8px ${c}`,
    `0 0 18px ${rgba(c,0.7)}`,
  ].join(',');
}

function tubeStroke(c){
  return `1px ${darken(c, 0.6)}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER NEON TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildNeonSpans(){
  neonEl.innerHTML = '';
  const chars = S.text || ' ';
  for(let i = 0; i < chars.length; i++){
    const ch = chars[i];
    if(ch === '\n'){
      const br = document.createElement('span');
      br.className = 'nchar-nl';
      neonEl.appendChild(br);
      continue;
    }
    const sp = document.createElement('span');
    sp.className = 'nchar';
    sp.dataset.idx = i;
    sp.textContent = ch === ' ' ? '\u00A0' : ch;
    const ov = S.charOverrides[i];
    if(ov){
      if(ov.font) sp.style.fontFamily = `'${ov.font}', cursive`;
      if(ov.color){
        sp.style.color = ov.color;
        if(S.power){
          const c = ov.color;
          sp.style.textShadow = tubeShadow(c);
          sp.style.webkitTextStroke = tubeStroke(c);
        }
      }
    }
    if(i === activeCharIdx) sp.classList.add('selected');
    neonEl.appendChild(sp);
  }
  if(activeCharIdx !== null && charMenu.classList.contains('visible')){
    const freshSpan = neonEl.querySelector(`.nchar[data-idx="${activeCharIdx}"]`);
    if(freshSpan) _repositionMenu(freshSpan);
  }
}

function _repositionMenu(spanEl){
  const wRect = signWrapper.getBoundingClientRect();
  const sRect = spanEl.getBoundingClientRect();
  const sc    = S.scale;
  const cx    = (sRect.left + sRect.width / 2 - wRect.left) / sc;
  const ty    = (sRect.top - wRect.top) / sc - 14;
  charMenu.style.left      = cx + 'px';
  charMenu.style.top       = ty + 'px';
  charMenu.style.transform = 'translateX(-50%) translateY(-100%)';
}

function renderNeon(){
  neonEl.style.fontFamily = `'${S.font}', cursive`;
  neonEl.style.fontSize   = currentFS + 'px';

  signWrapper.style.left      = `calc(50% + ${S.posX}px)`;
  signWrapper.style.top       = `calc(50% + ${S.posY}px)`;
  signWrapper.style.transform = `translate(-50%,-50%) rotateY(${S.tiltY}deg) rotate(${S.rotation}deg) scale(${S.scale})`;

  if(!S.power){
    neonEl.style.color = '#5a5a5a';
    neonEl.style.textShadow = 'none';
    neonEl.style.webkitTextStroke = '0px transparent';
    buildNeonSpans();
    neonEl.querySelectorAll('.nchar').forEach(sp => {
      sp.style.textShadow = 'none';
      sp.style.webkitTextStroke = '0px transparent';
      sp.style.color = '';
    });
    if(S.backing) drawAcrylic();
    return;
  }

  const c = (S.rgb && rgbInt) ? currentRGBColor : S.color;
  neonEl.style.color = c;
  neonEl.style.textShadow = tubeShadow(c);
  neonEl.style.webkitTextStroke = tubeStroke(c);

  buildNeonSpans();

  if(S.backing) drawAcrylic();
}

function updateDimBadge(){
  const cmW = Math.round(40 * S.scale);
  document.getElementById('dimBadge').textContent = `~ ${cmW} Ã— ${Math.round(cmW*.38)} cm`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POSITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyTransform(){
  signWrapper.style.left      = `calc(50% + ${S.posX}px)`;
  signWrapper.style.top       = `calc(50% + ${S.posY}px)`;
  signWrapper.style.transform = `translate(-50%,-50%) rotateY(${S.tiltY}deg) rotate(${S.rotation}deg) scale(${S.scale})`;
}
function resetPosition(){ S.posX=0; S.posY=0; S.scale=1; S.rotation=0; S.tiltY=0; renderNeon(); updateDimBadge(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOUNT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyMount(){
  mountPlate.style.cssText=''; mountHook.style.display='none';
  mountBase.style.display='none'; mountScrews.style.display='none';

  const hasPlate = ['acrilico-cuadrado','acrilico-redondo','colgar'].includes(S.mount);
  if(hasPlate && S.backing){
    acrylicCvs.style.opacity='0';
  } else if(S.backing){
    drawAcrylic();
  }

  if(S.mount==='colgar'){
    mountHook.style.cssText='display:block;position:absolute;left:50%;top:-70px;transform:translateX(-50%);width:2px;height:70px;background:repeating-linear-gradient(to bottom,#aaa 0,#aaa 4px,#888 4px,#888 8px);box-shadow:0 0 4px rgba(0,0,0,.5);';
    mountPlate.style.cssText='position:absolute;inset:-18px -22px;border-radius:10px;background:linear-gradient(160deg,rgba(220,230,245,.18) 0%,rgba(180,195,220,.12) 50%,rgba(200,215,235,.16) 100%);opacity:1;backdrop-filter:blur(1px);box-shadow:0 4px 28px rgba(0,0,0,.55),inset 0 0 0 1.5px rgba(255,255,255,.22),inset 0 1px 0 rgba(255,255,255,.35);';
  }

  if(S.mount==='acrilico-cuadrado'){
    mountPlate.style.cssText='position:absolute;inset:-18px -22px;border-radius:10px;background:linear-gradient(160deg,rgba(220,230,245,.18) 0%,rgba(180,195,220,.12) 50%,rgba(200,215,235,.16) 100%);opacity:1;backdrop-filter:blur(1px);box-shadow:0 4px 28px rgba(0,0,0,.55),inset 0 0 0 1.5px rgba(255,255,255,.22),inset 0 1px 0 rgba(255,255,255,.35);';
  }

  if(S.mount==='acrilico-redondo'){
    const w=signWrapper.offsetWidth+44, h=signWrapper.offsetHeight+44;
    const side=Math.max(w,h);
    const offsetX=(w-side)/2-22, offsetY=(h-side)/2-22;
    mountPlate.style.cssText='position:absolute;width:'+side+'px;height:'+side+'px;left:'+offsetX+'px;top:'+offsetY+'px;border-radius:50%;background:linear-gradient(160deg,rgba(220,230,245,.18) 0%,rgba(180,195,220,.12) 50%,rgba(200,215,235,.16) 100%);opacity:1;backdrop-filter:blur(1px);box-shadow:0 4px 28px rgba(0,0,0,.55),inset 0 0 0 1.5px rgba(255,255,255,.22),inset 0 1px 0 rgba(255,255,255,.35);';
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAR EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FONTS_LIST = [
  {k:'Pacifico',       l:'Pacifico'},
  {k:'Courgette',      l:'Courgette'},
  {k:'Yellowtail',     l:'Yellowtail'},
  {k:'Cookie',         l:'Cookie'},
  {k:'Kaushan Script', l:'Kaushan'},
  {k:'Comfortaa',      l:'Comfortaa'},
  {k:'Nunito',         l:'Nunito'},
  {k:'Raleway',        l:'Raleway'},
  {k:'Righteous',      l:'Righteous'},
  {k:'Orbitron',       l:'Orbitron'},
];
const COLORS_LIST = [
  {c:'#b3f0ff',n:'Azul Hielo'},{c:'#ff2222',n:'Roja'},{c:'#ffb300',n:'Amber'},
  {c:'#e8ff00',n:'Amarillo LimÃ³n'},{c:'#bf00ff',n:'Morado'},{c:'#00ff88',n:'Verde'},
  {c:'#39ff14',n:'Verde Mars'},{c:'#3b82f6',n:'Azul'},{c:'#ff3cac',n:'Rosa'},
  {c:'#ffd700',n:'Amarillo Dorado'},{c:'#ff8800',n:'Naranja'},{c:'#e8f4ff',n:'Blanca FrÃ­a'},
];

const charMenu      = document.getElementById('charMenu');
charMenu.addEventListener('pointerdown', e => e.stopPropagation());
const cmenuFontName = document.getElementById('cmenuFontName');
const cmenuColorBtn = document.getElementById('cmenuColorBtn');
const cmenuColorSub = document.getElementById('cmenuColorSub');
let activeCharIdx   = null;
let cmenuFontIdx    = 0;

COLORS_LIST.forEach(col => {
  const sw = document.createElement('div');
  sw.className = 'cmenu-csw';
  sw.style.background = col.c;
  sw.title = col.n;
  sw.dataset.color = col.c;
  cmenuColorSub.appendChild(sw);
});

function openCharMenu(spanEl){
  const idx = parseInt(spanEl.dataset.idx);
  activeCharIdx = idx;

  neonEl.querySelectorAll('.nchar.selected').forEach(s => s.classList.remove('selected'));
  spanEl.classList.add('selected');

  const ov       = S.charOverrides[idx] || {};
  const curFont  = ov.font  || S.font;
  const curColor = ov.color || S.color;

  cmenuFontIdx = FONTS_LIST.findIndex(f => f.k === curFont);
  if(cmenuFontIdx < 0) cmenuFontIdx = 0;
  updateFontCarousel();

  cmenuColorBtn.style.background = curColor;
  cmenuColorSub.querySelectorAll('.cmenu-csw').forEach(s =>
    s.classList.toggle('on', s.dataset.color === curColor)
  );
  cmenuColorSub.classList.remove('open');

  _repositionMenu(spanEl);
  charMenu.classList.add('visible');
}

function closeCharMenu(){
  charMenu.classList.remove('visible');
  cmenuColorSub.classList.remove('open');
  neonEl.querySelectorAll('.nchar.selected').forEach(s => s.classList.remove('selected'));
  activeCharIdx = null;
}

function updateFontCarousel(){
  const f = FONTS_LIST[cmenuFontIdx];
  cmenuFontName.textContent   = f.l;
  cmenuFontName.style.fontFamily = `'${f.k}', cursive`;
}

function applyCarouselFont(){
  if(activeCharIdx === null) return;
  if(!S.charOverrides[activeCharIdx]) S.charOverrides[activeCharIdx] = {};
  S.charOverrides[activeCharIdx].font = FONTS_LIST[cmenuFontIdx].k;
  renderNeon();
}

document.getElementById('cmenuPrev').addEventListener('click', e => {
  e.stopPropagation();
  cmenuFontIdx = (cmenuFontIdx - 1 + FONTS_LIST.length) % FONTS_LIST.length;
  updateFontCarousel(); applyCarouselFont();
});
document.getElementById('cmenuNext').addEventListener('click', e => {
  e.stopPropagation();
  cmenuFontIdx = (cmenuFontIdx + 1) % FONTS_LIST.length;
  updateFontCarousel(); applyCarouselFont();
});

cmenuColorBtn.addEventListener('click', e => {
  e.stopPropagation();
  cmenuColorSub.classList.toggle('open');
});

cmenuColorSub.addEventListener('click', e => {
  const sw = e.target.closest('.cmenu-csw'); if(!sw) return;
  e.stopPropagation();
  if(activeCharIdx === null) return;
  if(!S.charOverrides[activeCharIdx]) S.charOverrides[activeCharIdx] = {};
  S.charOverrides[activeCharIdx].color = sw.dataset.color;
  cmenuColorBtn.style.background = sw.dataset.color;
  cmenuColorSub.querySelectorAll('.cmenu-csw').forEach(s => s.classList.toggle('on', s === sw));
  cmenuColorSub.classList.remove('open');
  renderNeon();
});

document.getElementById('cmenuReset').addEventListener('click', e => {
  e.stopPropagation();
  if(activeCharIdx === null) return;
  delete S.charOverrides[activeCharIdx];
  closeCharMenu();
  renderNeon();
});

document.addEventListener('pointerdown', e => {
  if(!charMenu.classList.contains('visible')) return;
  if(charMenu.contains(e.target)) return;
  if(e.target.closest('.nchar')) return;
  closeCharMenu();
});

signWrapper.addEventListener('pointermove', () => {
  if(dragging) closeCharMenu();
});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROTATE HANDLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rotHandle   = document.getElementById('rotateHandle');
const angleBadge  = document.getElementById('angleBadge');
let rotating      = false;
let rotStartAngle = 0;
let rotAtStart    = 0;

function getAngleFromCenter(clientX, clientY){
  const rect = signWrapper.getBoundingClientRect();
  const cx   = rect.left + rect.width  / 2;
  const cy   = rect.top  + rect.height / 2;
  return Math.atan2(clientY - cy, clientX - cx) * (180 / Math.PI);
}

rotHandle.addEventListener('pointerdown', e => {
  e.stopPropagation();
  e.preventDefault();
  rotating      = true;
  rotStartAngle = getAngleFromCenter(e.clientX, e.clientY);
  rotAtStart    = S.rotation;
  rotHandle.setPointerCapture(e.pointerId);
  rotHandle.classList.add('active');
  angleBadge.classList.add('visible');
});

rotHandle.addEventListener('pointermove', e => {
  if(!rotating) return;
  const current = getAngleFromCenter(e.clientX, e.clientY);
  let delta = current - rotStartAngle;
  S.rotation = rotAtStart + delta;
  const snaps = [0, 90, 180, 270, -90, -180, -270, 360, -360];
  const nearest = snaps.find(s => Math.abs((S.rotation % 360) - s) < 4 || Math.abs(S.rotation - s) < 4);
  if(nearest !== undefined){
    const diff = S.rotation - Math.round(S.rotation / 90) * 90;
    if(Math.abs(diff) < 4) S.rotation = Math.round(S.rotation / 90) * 90;
  }
  applyTransform();
  const display = ((Math.round(S.rotation) % 360) + 360) % 360;
  angleBadge.textContent = display + 'Â°';
});

rotHandle.addEventListener('pointerup', () => {
  rotating = false;
  rotHandle.classList.remove('active');
  setTimeout(() => angleBadge.classList.remove('visible'), 800);
  scheduleHint();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIZE HINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sizeHint   = document.getElementById('sizeHint');
let hintTimer    = null;
let hintShown    = false;

function scheduleHint(){
  clearTimeout(hintTimer);
  hideHint();
  hintTimer = setTimeout(showHint, 1500);
}

function showHint(){
  if(hintShown) return;
  hintShown = true;
  sizeHint.style.opacity = '1';
  hintTimer = setTimeout(hideHint, 3000);
}

function hideHint(){
  hintShown = false;
  sizeHint.style.opacity = '0';
  clearTimeout(hintTimer);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TILT HANDLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tiltHandleY = document.getElementById('tiltHandleY');
const tiltBadge   = document.getElementById('tiltBadge');
let tilting       = false;
let tiltStartX    = 0;
let tiltAtStart   = 0;
let tiltTimer     = null;

tiltHandleY.addEventListener('pointerdown', e => {
  e.stopPropagation(); e.preventDefault();
  tilting      = true;
  tiltStartX   = e.clientX;
  tiltAtStart  = S.tiltY;
  hideHint();
  tiltHandleY.setPointerCapture(e.pointerId);
  tiltHandleY.classList.add('active');
  tiltBadge.classList.add('visible');
});

document.addEventListener('pointermove', e => {
  if(!tilting) return;
  let val = tiltAtStart + (e.clientX - tiltStartX) * 0.4;
  val = Math.max(-80, Math.min(80, val));
  if(Math.abs(val) < 3) val = 0;
  S.tiltY = val;
  applyTransform();
  tiltBadge.textContent = Math.round(val) + 'Â°';
});

document.addEventListener('pointerup', () => {
  if(!tilting) return;
  tilting = false;
  tiltHandleY.classList.remove('active');
  clearTimeout(tiltTimer);
  tiltTimer = setTimeout(() => tiltBadge.classList.remove('visible'), 800);
  scheduleHint();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG â€” letrero
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dragging=false, dragStartX=0, dragStartY=0, posAtDragX=0, posAtDragY=0;
let pointerDownTarget=null;
let charPointerMoved=false;
signWrapper.addEventListener('pointerdown',e=>{
  if(e.target.closest('#resizeHandle')) return;
  hideHint();
  pointerDownTarget=e.target;
  charPointerMoved=false;
  dragging=true; dragStartX=e.clientX; dragStartY=e.clientY;
  posAtDragX=S.posX; posAtDragY=S.posY;
  signWrapper.setPointerCapture(e.pointerId); e.preventDefault(); e.stopPropagation();
});
signWrapper.addEventListener('pointermove',e=>{
  if(!dragging) return;
  const dx=e.clientX-dragStartX, dy=e.clientY-dragStartY;
  if(Math.abs(dx)>4||Math.abs(dy)>4) charPointerMoved=true;
  S.posX=posAtDragX+dx;
  S.posY=posAtDragY+dy;
  applyTransform();
});
signWrapper.addEventListener('pointerup',e=>{
  dragging=false;
  if(!charPointerMoved){
    const sp=pointerDownTarget && pointerDownTarget.closest('.nchar');
    if(sp) openCharMenu(sp);
  }
  pointerDownTarget=null;
  scheduleHint();
});

// DRAG â€” fondo
let bgDragging=false, bgStartX=0, bgStartY=0, bgAtX=50, bgAtY=50;
previewCanvas.addEventListener('pointerdown',e=>{
  if(e.target.closest('#signWrapper')) return;
  bgDragging=true; bgStartX=e.clientX; bgStartY=e.clientY; bgAtX=S.bgX; bgAtY=S.bgY;
  previewCanvas.style.cursor='grabbing'; previewCanvas.setPointerCapture(e.pointerId);
});
previewCanvas.addEventListener('pointermove',e=>{
  if(!bgDragging) return;
  S.bgX=Math.max(0,Math.min(100,bgAtX-(e.clientX-bgStartX)*.04));
  S.bgY=Math.max(0,Math.min(100,bgAtY-(e.clientY-bgStartY)*.04));
  previewCanvas.style.backgroundPosition=`${S.bgX}% ${S.bgY}%`;
});
previewCanvas.addEventListener('pointerup',()=>{ bgDragging=false; previewCanvas.style.cursor='default'; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rHandle=document.getElementById('resizeHandle');
let resizing=false, resizeStartX=0, scaleAtResize=1;
rHandle.addEventListener('pointerdown',e=>{ hideHint(); resizing=true; resizeStartX=e.clientX; scaleAtResize=S.scale; rHandle.setPointerCapture(e.pointerId); e.stopPropagation(); e.preventDefault(); });
rHandle.addEventListener('pointermove',e=>{ if(!resizing)return; S.scale=Math.max(.15,Math.min(3,scaleAtResize+(e.clientX-resizeStartX)*.006)); renderNeon(); updateDimBadge(); });
rHandle.addEventListener('pointerup',()=>{ resizing=false; scheduleHint(); });

previewCanvas.addEventListener('wheel',e=>{ e.preventDefault(); S.scale=Math.max(.15,Math.min(3,S.scale-e.deltaY*.001)); renderNeon(); updateDimBadge(); },{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PINCH TO ZOOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastPinchDist=null;
previewCanvas.addEventListener('touchstart',e=>{ if(e.touches.length===2){lastPinchDist=getPinchDist(e.touches);e.preventDefault();} },{passive:false});
previewCanvas.addEventListener('touchmove',e=>{ if(e.touches.length===2&&lastPinchDist!==null){ const d=getPinchDist(e.touches); S.scale=Math.max(.15,Math.min(3,S.scale+(d-lastPinchDist)*.005)); lastPinchDist=d; renderNeon(); updateDimBadge(); e.preventDefault(); } },{passive:false});
previewCanvas.addEventListener('touchend',e=>{ if(e.touches.length<2)lastPinchDist=null; });
function getPinchDist(t){return Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('textInput').addEventListener('input',function(){
  const v=this.value.slice(0,60); this.value=v; S.text=v;
  document.getElementById('charCount').textContent=v.length+' caracteres';
  S.charOverrides={}; closeCharMenu(); recalcFontSize(); updateDimBadge(); dots();
});
document.getElementById('fontGrid').addEventListener('click',e=>{
  const b=e.target.closest('.fbtn'); if(!b)return;
  document.querySelectorAll('.fbtn').forEach(x=>x.classList.remove('on'));
  b.classList.add('on'); S.font=b.dataset.font; recalcFontSize(); dots();
});
document.getElementById('colorGrid').addEventListener('click',e=>{
  const s=e.target.closest('.cswatch'); if(!s)return;
  document.querySelectorAll('.cswatch').forEach(x=>x.classList.remove('on'));
  s.classList.add('on'); S.color=s.dataset.c;
  document.getElementById('colorLabel').textContent=s.dataset.n;
  renderNeon(); dots();
});
document.getElementById('wallGrid').addEventListener('click',e=>{
  const b=e.target.closest('.wbtn'); if(!b)return;
  document.querySelectorAll('.wbtn').forEach(x=>x.classList.remove('on'));
  b.classList.add('on');
  previewCanvas.style.backgroundImage=`url('${b.dataset.url}')`;
  overlay.style.background=`rgba(0,0,0,${b.dataset.ov})`;
  dots();
});
document.getElementById('mountGrid').addEventListener('click',e=>{
  const b=e.target.closest('.mbtn'); if(!b)return;
  document.querySelectorAll('.mbtn').forEach(x=>x.classList.remove('on'));
  b.classList.add('on'); S.mount=b.dataset.m;
  if(S.mount==='libre' && S.backing) drawAcrylic();
  applyMount(); dots();
});

document.getElementById('tBacking').addEventListener('change',function(){
  S.backing=this.checked;
  if(S.backing){
    if(S.mount!=='libre'){
      S.mount='libre';
      document.querySelectorAll('.mbtn').forEach(x=>x.classList.remove('on'));
      document.querySelector('.mbtn[data-m="libre"]').classList.add('on');
      mountPlate.style.cssText=''; mountHook.style.display='none';
      mountBase.style.display='none'; mountScrews.style.display='none';
    }
    drawAcrylic();
  } else {
    acrylicCvs.style.opacity='0';
  }
  dots();
});
document.getElementById('tRgb').addEventListener('change',function(){ S.rgb=this.checked; this.checked?startRGB():stopRGB(); dots(); });
document.getElementById('tFlicker').addEventListener('change',function(){ S.flicker=this.checked; neonEl.classList.toggle('flicker',this.checked); dots(); });
document.getElementById('tDimmer').addEventListener('change',function(){ S.dimmer=this.checked; neonEl.classList.toggle('dimmed',this.checked); dots(); });

document.getElementById('tPower').addEventListener('change',function(){
  S.power=this.checked;
  if(this.checked){ renderNeon(); neonEl.classList.toggle('flicker',S.flicker); neonEl.classList.toggle('dimmed',S.dimmer); }
  else { neonEl.style.color='#5a5a5a'; neonEl.style.textShadow='none'; neonEl.classList.remove('flicker','dimmed'); if(S.backing)drawAcrylic(); }
});

function toggleFlicker(){
  const t=document.getElementById('tFlicker');
  t.checked=!t.checked; S.flicker=t.checked; neonEl.classList.toggle('flicker',t.checked); dots();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let rainAF=null;
const drops=[];
function initRain(){
  const w=previewCanvas.offsetWidth,h=previewCanvas.offsetHeight;
  rainCvs.width=w; rainCvs.height=h; drops.length=0;
  for(let i=0;i<120;i++) drops.push({x:Math.random()*w,y:Math.random()*h,len:8+Math.random()*14,speed:6+Math.random()*8,op:.15+Math.random()*.35});
}
function drawRain(){
  const w=rainCvs.width,h=rainCvs.height;
  rainCtx.clearRect(0,0,w,h); rainCtx.strokeStyle='rgba(180,220,255,.55)'; rainCtx.lineWidth=1;
  drops.forEach(d=>{
    rainCtx.globalAlpha=d.op; rainCtx.beginPath(); rainCtx.moveTo(d.x,d.y); rainCtx.lineTo(d.x+d.len*.18,d.y+d.len); rainCtx.stroke();
    d.y+=d.speed; d.x+=d.speed*.18; if(d.y>h){d.y=-d.len;d.x=Math.random()*w;}
  });
  rainCtx.globalAlpha=1;
}
function startRain(){ initRain(); (function loop(){ drawRain(); rainAF=requestAnimationFrame(loop); })(); }
function stopRain(){ cancelAnimationFrame(rainAF); rainCtx.clearRect(0,0,rainCvs.width,rainCvs.height); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOWNLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function downloadPreview(){
  const cvs=document.createElement('canvas'); cvs.width=1400; cvs.height=700;
  const ctx=cvs.getContext('2d');
  ctx.fillStyle='#111'; ctx.fillRect(0,0,1400,700);
  const lines=S.text.split('\n'), mx=Math.max(...lines.map(l=>l.length),1);
  const fs=Math.max(44,Math.min(180,900/mx));
  ctx.font=`${fs}px '${S.font}'`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle=S.color;
  const lh=fs*1.3, sy=350-((lines.length-1)*lh)/2;
  lines.forEach((ln,i)=>{ ctx.shadowColor=S.color; for(let g=0;g<5;g++){ctx.shadowBlur=18*(g+1);ctx.fillText(ln,700,sy+i*lh);} });
  const a=document.createElement('a'); a.download='mi-neon.png'; a.href=cvs.toDataURL(); a.click();
}

function shareDesign(){
  const p=new URLSearchParams({t:S.text,f:S.font,c:S.color});
  const url=location.href.split('?')[0]+'?'+p;
  navigator.clipboard.writeText(url).then(()=>{
    const b=document.getElementById('btnShare');
    b.textContent='âœ“ Â¡Copiado!';
    setTimeout(()=>b.innerHTML='ğŸ”— <span class="btn-text">Compartir</span>',2500);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dots(){
  const checks=[
    S.text.trim().length>0, S.font!=='Pacifico', S.color!=='#b3f0ff',
    !!document.querySelector('.wbtn.on:not(:first-child)'),
    S.mount!=='libre',
    S.backing||S.rgb||S.flicker||S.dimmer,
  ];
  checks.forEach((ok,i)=>document.getElementById('d'+(i+1)).classList.toggle('on',ok));
  document.getElementById('d1').classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOBILE SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const isMobile=()=>window.innerWidth<=768;
const SHEET_COLLAPSED=52, SHEET_HALF=220, SHEET_FULL=380;
let sheetH=SHEET_COLLAPSED, sheetOpen=false;

function initMobileSheet(){
  if(!isMobile()) return;
  const handle=document.getElementById('sheetHandle');
  const tabsEl=document.getElementById('sheetTabs');
  const blocks=document.querySelectorAll('.block[data-tab]');
  const sh=document.getElementById('scrollHint');
  handle.style.display='flex'; tabsEl.style.display='flex';
  if(sh) sh.textContent='âœŒï¸ Pellizca para redimensionar';
  tabsEl.innerHTML='';
  blocks.forEach((b,i)=>{
    const btn=document.createElement('button');
    btn.className='stab'+(i===0?' on':'');
    btn.textContent=b.dataset.tab;
    btn.addEventListener('click',()=>switchTab(i));
    tabsEl.appendChild(btn);
  });
  switchTab(0);
  if(handle._init) return; handle._init=true;
  handle.addEventListener('click',()=>{ sheetOpen=!sheetOpen; setSheetHeight(sheetOpen?SHEET_HALF:SHEET_COLLAPSED); });
  let sheetDragStartY=0, sheetHAtStart=0, sheetDragging=false;
  handle.addEventListener('pointerdown',e=>{ sheetDragging=true; sheetDragStartY=e.clientY; sheetHAtStart=sheetH; handle.setPointerCapture(e.pointerId); e.stopPropagation(); });
  handle.addEventListener('pointermove',e=>{ if(!sheetDragging)return; setSheetHeight(Math.max(SHEET_COLLAPSED,Math.min(SHEET_FULL,sheetHAtStart+(sheetDragStartY-e.clientY))),false); });
  handle.addEventListener('pointerup',()=>{ sheetDragging=false; const snaps=[SHEET_COLLAPSED,SHEET_HALF,SHEET_FULL]; const cl=snaps.reduce((a,b)=>Math.abs(b-sheetH)<Math.abs(a-sheetH)?b:a); setSheetHeight(cl); sheetOpen=cl>SHEET_COLLAPSED; });
}

function setSheetHeight(h,animate=true){
  sheetH=h;
  const sb=document.getElementById('sidebar');
  sb.style.transition=animate?'height .3s cubic-bezier(.4,0,.2,1)':'none';
  sb.style.height=h+'px';
}
function switchTab(idx){
  document.querySelectorAll('.block[data-tab]').forEach((b,i)=>b.classList.toggle('active',i===idx));
  document.querySelectorAll('.stab').forEach((t,i)=>t.classList.toggle('on',i===idx));
  if(isMobile()&&sheetH<SHEET_HALF){setSheetHeight(SHEET_HALF);sheetOpen=true;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREVIEW MODE â€” con escala proporcional al canvas
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const btnPreview = document.getElementById('btnPreview');
let previewActive = false;
// Snapshot del estado antes de entrar al preview
let previewSnapshot = null;

btnPreview.addEventListener('click', (e) => {
  e.stopPropagation();
  if (previewActive) return;

  // Medir el canvas con precisiÃ³n subpÃ­xel ANTES de activar preview-mode
  const rectBefore = previewCanvas.getBoundingClientRect();

  previewActive = true;
  document.body.classList.add('preview-mode');

  // Esperar que el browser complete el reflow del nuevo layout
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      const rectAfter = previewCanvas.getBoundingClientRect();

      // Ratio independiente por eje
      const ratioW = rectAfter.width  / (rectBefore.width  || 1);
      const ratioH = rectAfter.height / (rectBefore.height || 1);

      // El fondo usa background-size:cover â†’ escala por el eje que MÃS creciÃ³.
      // El letrero tiene que seguir la misma lÃ³gica para mantenerse en proporciÃ³n.
      const ratio = Math.max(ratioW, ratioH);

      // Guardar estado para restaurar al salir
      previewSnapshot = {
        scale: S.scale,
        posX:  S.posX,
        posY:  S.posY,
      };

      // Aplicar el mismo factor de escala al letrero y a su posiciÃ³n
      S.scale = S.scale * ratio;
      S.posX  = S.posX  * ratioW;   // posiciÃ³n X escala por el ratio del eje X
      S.posY  = S.posY  * ratioH;   // posiciÃ³n Y escala por el ratio del eje Y
      applyTransform();
      updateDimBadge();
    });
  });

  document.addEventListener('click', exitPreview);
});

function exitPreview() {
  if (!previewActive) return;
  previewActive = false;
  document.body.classList.remove('preview-mode');
  document.removeEventListener('click', exitPreview);

  // Restaurar escala y posiciÃ³n exactas antes del preview
  if (previewSnapshot) {
    S.scale = previewSnapshot.scale;
    S.posX  = previewSnapshot.posX;
    S.posY  = previewSnapshot.posY;
    previewSnapshot = null;
    applyTransform();
    updateDimBadge();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL PARAMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const p=new URLSearchParams(location.search);
  if(p.get('t')){S.text=p.get('t');document.getElementById('textInput').value=S.text;}
  if(p.get('f')) S.font=p.get('f');
  if(p.get('c')) S.color=p.get('c');
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESIZE OBSERVER â€” solo actualiza posiciÃ³n/transform
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(window.ResizeObserver){
  new ResizeObserver(()=> applyTransform()).observe(previewCanvas);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WINDOW RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize',()=>{
  if(isMobile()){
    initMobileSheet();
  } else {
    const sb=document.getElementById('sidebar');
    sb.style.height=''; sb.style.transition='';
    document.querySelectorAll('.block').forEach(b=>{b.style.display='';b.classList.remove('active');});
    document.getElementById('sheetHandle').style.display='none';
    document.getElementById('sheetTabs').style.display='none';
  }
  applyTransform();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
recalcFontSize();
scheduleHint();
applyMount();
dots();
initMobileSheet();
</script>
</body>
</html>